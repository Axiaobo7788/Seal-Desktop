name: desktop-windows-portable

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  TOOLS_CACHE_VERSION: v1
  YT_DLP_URL: https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe
  FFMPEG_URL: https://github.com/BtbN/FFmpeg-Builds/releases/latest/download/ffmpeg-master-latest-win64-gpl.zip

jobs:
  build-windows-portable:
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - name: Cache tools (yt-dlp/ffmpeg)
        uses: actions/cache@v4
        with:
          path: |
            dist-bin
            ffmpeg-unpacked
          key: tools-${{ runner.os }}-${{ env.TOOLS_CACHE_VERSION }}

      - name: Download yt-dlp (x64)
        run: |
          $ErrorActionPreference = "Stop"
          if (Test-Path "dist-bin/yt-dlp.exe") {
            Write-Host "yt-dlp cache hit: dist-bin/yt-dlp.exe"
            exit 0
          }
          curl -L "$env:YT_DLP_URL" -o yt-dlp.exe
          mkdir -Force dist-bin
          mv yt-dlp.exe dist-bin/

      - name: Download FFmpeg (x64)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          if (Test-Path "dist-bin/ffmpeg.exe") {
            Write-Host "ffmpeg cache hit: dist-bin/ffmpeg.exe"
            exit 0
          }
          $url = "$env:FFMPEG_URL"
          Write-Host "Downloading FFmpeg from: $url"
          curl -L $url -o ffmpeg.zip

          $outDir = Join-Path "$env:GITHUB_WORKSPACE" "ffmpeg-unpacked"
          if (Test-Path $outDir) { Remove-Item $outDir -Recurse -Force }
          Expand-Archive -Path ffmpeg.zip -DestinationPath $outDir -Force

          $ffmpegExe = Get-ChildItem $outDir -Recurse -File -Filter ffmpeg.exe | Select-Object -First 1
          $ffprobeExe = Get-ChildItem $outDir -Recurse -File -Filter ffprobe.exe | Select-Object -First 1
          if (-not $ffmpegExe) { throw "ffmpeg.exe not found in downloaded archive" }

          mkdir -Force dist-bin | Out-Null
          Copy-Item $ffmpegExe.FullName -Destination (Join-Path "dist-bin" "ffmpeg.exe") -Force
          if ($ffprobeExe) {
            Copy-Item $ffprobeExe.FullName -Destination (Join-Path "dist-bin" "ffprobe.exe") -Force
          }

      # 如需 x86/arm64 可再加下载，改文件名存放到 dist-bin/ 并在后续打包时挑选
      # - name: Download yt-dlp (arm64)
      #   run: curl -L ".../yt-dlp_arm64.exe" -o dist-bin/yt-dlp_arm64.exe

      - name: Build portable zip (Windows)
        run: |
          ./gradlew :desktop:createReleaseDistributable --stacktrace
        shell: bash

      - name: Inject yt-dlp into distribution (and locate app root)
        shell: pwsh
        run: |
          $workspace = "$env:GITHUB_WORKSPACE"
          $desktopBuild = Join-Path $workspace "desktop/build"
          if (-not (Test-Path $desktopBuild)) {
            throw "Build directory not found: $desktopBuild"
          }

          $binariesRoot = Join-Path $workspace "desktop/build/compose/binaries"
          if (-not (Test-Path $binariesRoot)) {
            $binariesRoot = (Get-ChildItem $desktopBuild -Recurse -Directory -Filter binaries |
              Where-Object { $_.FullName -like "*compose*binaries" } |
              Select-Object -First 1).FullName
          }
          if (-not $binariesRoot -or -not (Test-Path $binariesRoot)) {
            throw "Compose binaries path not found under: $desktopBuild"
          }

          function Find-AppRoot([string]$root) {
            $candidates = Get-ChildItem $root -Recurse -Directory -Depth 10 |
              Where-Object { (Test-Path (Join-Path $_.FullName 'app')) -and (Test-Path (Join-Path $_.FullName 'runtime')) }
            if ($candidates) {
              return ($candidates | Sort-Object { $_.FullName.Length } | Select-Object -First 1)
            }

            $binDirs = Get-ChildItem $root -Recurse -Directory -Filter bin -Depth 12
            foreach ($bin in $binDirs) {
              $parent = Split-Path -Parent $bin.FullName
              if ($parent -like "*\\runtime") { continue }
              if ($bin.FullName -like "*\\runtime\\bin") { continue }
              $exe = Get-ChildItem $parent -File -Filter *.exe -ErrorAction SilentlyContinue |
                Where-Object { $_.Name -ne 'yt-dlp.exe' } |
                Select-Object -First 1
              $bat = Get-ChildItem $parent -File -Filter *.bat -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($exe -or $bat) {
                return Get-Item $parent
              }
            }
            return $null
          }

          $appRootDir = Find-AppRoot $binariesRoot
          if (-not $appRootDir) {
            Write-Host "Available directories under ${binariesRoot} (depth<=4):"
            Get-ChildItem $binariesRoot -Directory -Recurse -Depth 4 | ForEach-Object { Write-Host "- $($_.FullName)" }
            throw "Cannot locate Windows distributable app root (expected a directory containing both app/ and runtime/)"
          }

          $appRoot = $appRootDir.FullName
          Write-Host "Resolved app root: $appRoot"

          $binDir = Join-Path $appRoot "bin"
          New-Item -ItemType Directory -Force -Path $binDir | Out-Null
          Copy-Item (Join-Path $workspace "dist-bin/yt-dlp.exe") -Destination (Join-Path $binDir "yt-dlp.exe") -Force

          $ffmpegSrc = Join-Path $workspace "dist-bin/ffmpeg.exe"
          if (Test-Path $ffmpegSrc) {
            Copy-Item $ffmpegSrc -Destination (Join-Path $binDir "ffmpeg.exe") -Force
          }
          $ffprobeSrc = Join-Path $workspace "dist-bin/ffprobe.exe"
          if (Test-Path $ffprobeSrc) {
            Copy-Item $ffprobeSrc -Destination (Join-Path $binDir "ffprobe.exe") -Force
          }

          $launcherExe = Get-ChildItem $appRoot -File -Filter *.exe -ErrorAction SilentlyContinue |
            Where-Object { $_.Name -ne 'yt-dlp.exe' } |
            Select-Object -First 1
          if (-not $launcherExe) {
            $launcherExe = Get-ChildItem $binDir -File -Filter *.exe -ErrorAction SilentlyContinue |
              Where-Object { $_.Name -ne 'yt-dlp.exe' } |
              Select-Object -First 1
          }
          if ($launcherExe) {
            Write-Host "Launcher exe: $($launcherExe.FullName)"
          } else {
            $launcherBat = Get-ChildItem $appRoot -File -Filter *.bat -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($launcherBat) {
              Write-Host "No launcher .exe found; launcher bat: $($launcherBat.FullName)"
            } else {
              Write-Host "Files at app root:" 
              Get-ChildItem $appRoot -File | ForEach-Object { Write-Host "- $($_.Name)" }
              Write-Host "Files at app root/bin:" 
              Get-ChildItem $binDir -File | ForEach-Object { Write-Host "- $($_.Name)" }
              throw "No launcher (.exe/.bat) found in distributable; packaging root is likely wrong"
            }
          }

          "PORTABLE_DIR=$appRoot" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-portable-win-x64
          path: ${{ env.PORTABLE_DIR }}
