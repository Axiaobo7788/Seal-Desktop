name: desktop-windows-portable

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-windows-portable:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - name: Download yt-dlp (x64)
        run: |
          $ErrorActionPreference = "Stop"
          curl -L "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe" -o yt-dlp.exe
          mkdir -Force dist-bin
          mv yt-dlp.exe dist-bin/

      # 如需 x86/arm64 可再加下载，改文件名存放到 dist-bin/ 并在后续打包时挑选
      # - name: Download yt-dlp (arm64)
      #   run: curl -L ".../yt-dlp_arm64.exe" -o dist-bin/yt-dlp_arm64.exe

      - name: Build portable zip (Windows)
        run: |
          # 生成“可分发目录”（portable 的基础），比依赖 installer/zip 更稳定
          ./gradlew :desktop:createReleaseDistributable --stacktrace
        shell: bash

      - name: Debug build outputs (Windows)
        shell: pwsh
        run: |
          $workspace = "$env:GITHUB_WORKSPACE"
          $buildDir = Join-Path $workspace "desktop/build"
          Write-Host "Listing: $buildDir"
          if (Test-Path $buildDir) {
            Get-ChildItem $buildDir -Directory | ForEach-Object { Write-Host "- $($_.FullName)" }
          }
          $composeDir = Join-Path $buildDir "compose"
          Write-Host "Listing: $composeDir"
          if (Test-Path $composeDir) {
            Get-ChildItem $composeDir -Directory -Recurse -Depth 3 | ForEach-Object { Write-Host "- $($_.FullName)" }
          }

      - name: Inject yt-dlp into distribution (and locate app root)
        shell: pwsh
        run: |
          # 使用工作区绝对路径，避免嵌套 checkout 造成相对路径偏移
          $workspace = "$env:GITHUB_WORKSPACE"
          $desktopBuild = Join-Path $workspace "desktop/build"
          if (-not (Test-Path $desktopBuild)) {
            throw "Build directory not found: $desktopBuild"
          }

          # 尝试定位 compose/binaries 根目录（不同 Compose/Gradle 版本目录结构可能不同）
          $binariesRoot = Join-Path $workspace "desktop/build/compose/binaries"
          if (-not (Test-Path $binariesRoot)) {
            $binariesRoot = (Get-ChildItem $desktopBuild -Recurse -Directory -Filter binaries |
              Where-Object { $_.FullName -like "*compose*binaries" } |
              Select-Object -First 1).FullName
          }
          if (-not $binariesRoot -or -not (Test-Path $binariesRoot)) {
            throw "Compose binaries path not found under: $desktopBuild"
          }

          function Find-AppRoot([string]$root) {
            # 首选：jpackage app-image 根目录（同时包含 app/ 与 runtime/）
            $candidates = Get-ChildItem $root -Recurse -Directory -Depth 10 |
              Where-Object { (Test-Path (Join-Path $_.FullName 'app')) -and (Test-Path (Join-Path $_.FullName 'runtime')) }
            if ($candidates) {
              return ($candidates | Sort-Object { $_.FullName.Length } | Select-Object -First 1)
            }

            # 兜底：找“看起来像 launcher 根”的目录，避免误选到 runtime/bin
            $binDirs = Get-ChildItem $root -Recurse -Directory -Filter bin -Depth 12
            foreach ($bin in $binDirs) {
              $parent = Split-Path -Parent $bin.FullName
              if ($parent -like "*\\runtime") { continue }
              if ($bin.FullName -like "*\\runtime\\bin") { continue }
              $exe = Get-ChildItem $parent -File -Filter *.exe -ErrorAction SilentlyContinue |
                Where-Object { $_.Name -ne 'yt-dlp.exe' } |
                Select-Object -First 1
              $bat = Get-ChildItem $parent -File -Filter *.bat -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($exe -or $bat) {
                return Get-Item $parent
              }
            }
            return $null
          }

          $appRootDir = Find-AppRoot $binariesRoot
          if (-not $appRootDir) {
            Write-Host "Available directories under ${binariesRoot} (depth<=4):"
            Get-ChildItem $binariesRoot -Directory -Recurse -Depth 4 | ForEach-Object { Write-Host "- $($_.FullName)" }
            throw "Cannot locate Windows distributable app root (expected a directory containing both app/ and runtime/)"
          }

          $appRoot = $appRootDir.FullName
          Write-Host "Resolved app root: $appRoot"

          # 注入到 <appRoot>/bin/yt-dlp.exe（与运行时查找逻辑对齐）
          $binDir = Join-Path $appRoot "bin"
          New-Item -ItemType Directory -Force -Path $binDir | Out-Null
          Copy-Item (Join-Path $workspace "dist-bin/yt-dlp.exe") -Destination (Join-Path $binDir "yt-dlp.exe") -Force

          # 强校验：必须存在 launcher（优先 .exe，若没有则至少有 .bat）
          $launcherExe = Get-ChildItem $appRoot -File -Filter *.exe -ErrorAction SilentlyContinue |
            Where-Object { $_.Name -ne 'yt-dlp.exe' } |
            Select-Object -First 1
          if (-not $launcherExe) {
            $launcherExe = Get-ChildItem $binDir -File -Filter *.exe -ErrorAction SilentlyContinue |
              Where-Object { $_.Name -ne 'yt-dlp.exe' } |
              Select-Object -First 1
          }
          if ($launcherExe) {
            Write-Host "Launcher exe: $($launcherExe.FullName)"
          } else {
            $launcherBat = Get-ChildItem $appRoot -File -Filter *.bat -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($launcherBat) {
              Write-Host "No launcher .exe found; launcher bat: $($launcherBat.FullName)"
            } else {
              Write-Host "Files at app root:" 
              Get-ChildItem $appRoot -File | ForEach-Object { Write-Host "- $($_.Name)" }
              Write-Host "Files at app root/bin:" 
              Get-ChildItem $binDir -File | ForEach-Object { Write-Host "- $($_.Name)" }
              throw "No launcher (.exe/.bat) found in distributable; packaging root is likely wrong"
            }
          }

          # 将 appRoot 作为 artifact 上传路径（避免我们自己再套一层 zip）
          "PORTABLE_DIR=$appRoot" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-portable-win-x64
          path: ${{ env.PORTABLE_DIR }}
